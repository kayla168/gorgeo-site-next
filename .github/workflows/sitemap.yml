name: Generate and Submit Sitemap

on:
  push:
    branches:
      - main

jobs:
  sitemap:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # ⬅️ 关键！让 GITHUB_TOKEN 拥有推送权限

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # ⬅️ 关键！获取完整的 Git 历史，才能 push

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install

      - name: Generate sitemap
        run: |
          npx sitemap-generator-cli https://www.gorgeofasteners.com --output ./public/sitemap.xml

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@users.noreply.github.com"
          git config --global user.name "GitHub Actions"

      - name: Commit and Push sitemap.xml
        run: |
          git add public/sitemap.xml
          git commit -m "Auto-update sitemap.xml"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Submit sitemap to Google Search Console
        run: |
          curl -X POST -H "Authorization: Bearer ${{ secrets.GOOGLE_API_KEY }}" \
          -F "file=@public/sitemap.xml" \
          "https://www.googleapis.com/upload/searchconsole/v1/sites/https://www.gorgeofasteners.com/sitemaps"
